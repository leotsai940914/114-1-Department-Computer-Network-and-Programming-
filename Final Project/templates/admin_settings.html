{% extends "base.html" %}
{% block content %}

<div class="container" style="max-width: 780px; margin-top: 2rem;">

    <h2 class="section-title">網站設定（Admin Settings）</h2>

    <form method="POST" id="settingsForm" class="newpost-form">
        <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">

        <!-- 站名 -->
        <label class="form-label">網站名稱（Site Title）</label>
        <input type="text"
               class="form-input"
               name="site_title"
               value="{{ settings.site_title }}"
               required>

        <!-- 副標 -->
        <label class="form-label">網站副標（Subtitle）</label>
        <input type="text"
               class="form-input"
               name="subtitle"
               value="{{ settings.subtitle }}">

        <!-- 頁尾文字 -->
        <label class="form-label">頁尾文字（Footer）</label>
        <input type="text"
               class="form-input"
               name="footer_text"
               placeholder="寫下每一部電影留給我們的影像與思考"
               value="{{ settings.footer_text or '' }}">

        <!-- 作者頭像 -->
        <label class="form-label">作者頭像 URL（Avatar）</label>
        <input type="text"
               class="form-input"
               name="avatar_url"
               placeholder="https://example.com/avatar.jpg"
               value="{{ settings.avatar_url or '' }}">
        
        {% if settings.avatar_url %}
        <div style="margin: 0.5rem 0 1rem;">
            <img src="{{ settings.avatar_url }}"
                 alt="Avatar Preview"
                 style="width:100px; height:100px; border-radius:50%; object-fit:cover;">
        </div>
        {% endif %}

        <!-- About 介紹 -->
        <label class="form-label">關於本站（About）</label>

        <!-- Quill 工具列 -->
        <div id="toolbar">
            <span class="ql-formats">
                <select class="ql-header">
                    <option selected></option>
                    <option value="1">H1</option>
                    <option value="2">H2</option>
                    <option value="3">H3</option>
                </select>
            </span>

            <span class="ql-formats">
                <button class="ql-bold"></button>
                <button class="ql-italic"></button>
                <button class="ql-underline"></button>
            </span>

            <span class="ql-formats">
                <button class="ql-list" value="ordered"></button>
                <button class="ql-list" value="bullet"></button>
            </span>

            <span class="ql-formats">
                <button class="ql-blockquote"></button>
                <button class="ql-link"></button>
                <button class="ql-image"></button>
            </span>

            <span class="ql-formats">
                <button id="insert-hr">HR</button>
            </span>
        </div>

        <!-- Quill 編輯器 -->
        <div id="quillEditor" style="height: 260px; background: #fff;"></div>

        <!-- Hidden input：儲存 HTML -->
        <input type="hidden" name="about_html" id="aboutInput">

        <!-- 儲存按鈕 -->
        <button class="submit-btn" type="submit">儲存設定</button>

    </form>

    <!-- 主打文章設定 -->
    <div style="margin-top:2rem;">
        <h3 class="section-title">主打文章設定</h3>

        <form method="POST" style="margin-top:1rem;">
            <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="site_title" value="{{ settings.site_title }}">
            <input type="hidden" name="subtitle" value="{{ settings.subtitle }}">
            <input type="hidden" name="footer_text" value="{{ settings.footer_text }}">
            <input type="hidden" name="about_html" value="{{ settings.about_html }}">
            <input type="hidden" name="avatar_url" value="{{ settings.avatar_url }}">

            <label class="form-label">選擇主打文章</label>
            <select class="form-input" name="featured_post_id">
                <option value="">（不設定）</option>
                {% for p in posts %}
                <option value="{{ p.id }}"
                    {% if settings.featured_post_id == p.id %}selected{% endif %}>
                    {{ p.title }}
                </option>
                {% endfor %}
            </select>

            <label class="form-label">主打引言（Hero tagline）</label>
            <input type="text"
                   class="form-input"
                   name="featured_tagline"
                   placeholder="精選一篇值得細讀的影評與分析。"
                   value="{{ settings.featured_tagline or '' }}">

            <button class="submit-btn" type="submit" style="margin-top:1rem;">儲存主打設定</button>
        </form>
    </div>

    <!-- 作者資料 -->
    {% if session.get('user_id') %}
    <div style="margin-top:2rem;">
        <h3 class="section-title">作者資料</h3>
        <form method="POST" action="{{ url_for('admin_routes.admin_settings') }}">
            <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="site_title" value="{{ settings.site_title }}">
            <input type="hidden" name="subtitle" value="{{ settings.subtitle }}">
            <input type="hidden" name="footer_text" value="{{ settings.footer_text }}">
            <input type="hidden" name="about_html" value="{{ settings.about_html }}">
            <input type="hidden" name="avatar_url" value="{{ settings.avatar_url }}">
            <input type="hidden" name="featured_post_id" value="{{ settings.featured_post_id or '' }}">
            <input type="hidden" name="featured_tagline" value="{{ settings.featured_tagline or '' }}">

            <label class="form-label">作者頭像 URL（個人）</label>
            <input type="text" class="form-input" name="author_avatar"
                   placeholder="https://example.com/me.jpg"
                   value="{{ author.avatar_url if author else '' }}">

            {% if author and author.avatar_url %}
            <div style="margin:0.5rem 0 1rem;">
                <img src="{{ author.avatar_url }}"
                     alt="Author Avatar"
                     style="width:80px; height:80px; border-radius:50%; object-fit:cover;">
            </div>
            {% endif %}

            <label class="form-label">作者簡介</label>
            <textarea class="form-input" name="author_bio" rows="3"
                      placeholder="寫幾句關於你的話">{{ author.bio if author else '' }}</textarea>

            <button class="submit-btn" type="submit" style="margin-top:1rem;">儲存作者資料</button>
        </form>
    </div>
    {% endif %}

</div>

<!-- Quill JS / CSS -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const csrfToken = "{{ csrf_token() }}";

    // 建立 Quill 編輯器
    var quill = new Quill("#quillEditor", {
        theme: "snow",
        placeholder: "撰寫網站 About…",
        modules: {
            toolbar: {
                container: "#toolbar",
                handlers: {
                    image: function () {
                                const choice = prompt("輸入圖片網址，或直接按確定選擇本地檔");
                                if (choice && choice.trim()) {
                                    const range = quill.getSelection(true);
                                    quill.insertEmbed(range.index, "image", choice.trim());
                                    quill.setSelection(range.index + 1);
                                    return;
                                }

                                const input = document.createElement("input");
                                input.type = "file";
                                input.accept = "image/*";
                                input.onchange = async () => {
                                    const file = input.files[0];
                                    if (!file) return;

                                    // 簡單前端檔案大小限制（與後端 MAX_CONTENT_LENGTH 相同）
                                    const MAX_BYTES = 5 * 1024 * 1024;
                                    if (file.size > MAX_BYTES) {
                                        alert("圖片檔案需小於 5 MB");
                                        return;
                                    }

                                    const formData = new FormData();
                                    formData.append("file", file);

                                    try {
                                        const res = await fetch("{{ url_for('admin_routes.upload_image') }}", {
                                            method: "POST",
                                            body: formData,
                                            headers: { "X-CSRFToken": csrfToken },
                                        });
                                        const data = await res.json();
                                        if (!res.ok || !data.url) {
                                            throw new Error(data.error || "上傳失敗");
                                        }

                                        const range = quill.getSelection(true);
                                        quill.insertEmbed(range.index, "image", data.url);
                                        quill.setSelection(range.index + 1);
                                    } catch (err) {
                                        alert(err.message || "圖片上傳失敗");
                                    }
                                };
                                input.click();
                    }
                }
            }
        }
    });

    // 自訂 <hr>
    var Block = Quill.import("blots/block");
    class Divider extends Block {}
    Divider.blotName = "divider";
    Divider.tagName = "hr";
    Quill.register(Divider);

    document.getElementById("insert-hr").addEventListener("click", function () {
        let range = quill.getSelection();
        if (range) {
            quill.insertEmbed(range.index, "divider", true);
            quill.insertText(range.index + 1, "\n");
        }
    });

    // 載入舊的 HTML
    const rawHTML = `{{ settings.about_html | safe }}`;
    quill.root.innerHTML = rawHTML;

    // 表單送出 → 塞 hidden input
    document.getElementById("settingsForm").onsubmit = function () {
        document.getElementById("aboutInput").value =
            quill.root.innerHTML.trim();
    };

});
</script>

{% endblock %}
