{% extends "base.html" %}
{% block content %}

<div class="container">

    <h2 class="section-title">編輯文章 Edit Post</h2>

    <form id="editPostForm"
          class="newpost-form"
          method="POST"
          action="{{ url_for('post_routes.update_post', post_id=post.id) }}">
        <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">

        {% if error %}
        <p style="color:#b00020; margin-bottom:1rem;">
            {{ error }}
        </p>
        {% endif %}

        <!-- 標題 -->
        <label class="form-label">文章標題</label>
        <input type="text"
               class="form-input"
               name="title"
               value="{{ post.title }}"
               required>

        <!-- 內容 -->
        <label class="form-label">文章內容</label>

        <!-- 工具列 Toolbar -->
        <div id="toolbar-edit">
            <span class="ql-formats">
                <select class="ql-header">
                    <option selected></option>
                    <option value="1">H1</option>
                    <option value="2">H2</option>
                    <option value="3">H3</option>
                    <option value="4">H4</option>
                </select>
            </span>

            <span class="ql-formats">
                <button class="ql-bold"></button>
                <button class="ql-italic"></button>
                <button class="ql-underline"></button>
            </span>

            <span class="ql-formats">
                <button class="ql-align" value=""></button>
                <button class="ql-align" value="center"></button>
                <button class="ql-align" value="right"></button>
                <button class="ql-align" value="justify"></button>
            </span>

            <span class="ql-formats">
                <button class="ql-indent" value="-1"></button>
                <button class="ql-indent" value="+1"></button>
            </span>

            <span class="ql-formats">
                <button class="ql-list" value="ordered"></button>
                <button class="ql-list" value="bullet"></button>
            </span>

            <span class="ql-formats">
                <button class="ql-blockquote"></button>
                <button class="ql-code-block"></button>
            </span>

            <span class="ql-formats">
                <button class="ql-link"></button>
                <button class="ql-image"></button>
            </span>

            <span class="ql-formats">
                <button id="insert-hr-edit">HR</button>
            </span>

            <span class="ql-formats">
                <button class="ql-clean"></button>
            </span>
        </div>

        <!-- Quill 編輯器 -->
        <div id="quillEditor-edit" style="height: 350px; background: #fff;"></div>

        <!-- hidden input -->
        <input type="hidden" name="content" id="contentInput-edit">

        <!-- 分類 -->
        <label class="form-label">文章分類</label>
        <select class="form-input" name="category_id" required>
            {% for c in categories %}
            <option value="{{ c.id }}"
                {% if c.id == post.category_id %}selected{% endif %}>
                {{ c.name }}
            </option>
            {% endfor %}
        </select>

        <!-- 封面圖片 -->
        <label class="form-label">封面圖片 URL（選填）</label>
        <input type="text"
               class="form-input"
               name="cover_image"
               value="{{ post.cover_image_url or '' }}">

        <!-- 按鈕 -->
        <button class="submit-btn" type="submit">更新文章</button>

    </form>

    <!-- 即時預覽 -->
    <section class="preview-section">
        <h3 class="section-title">即時預覽</h3>
        <div class="preview-card">
            <div class="preview-cover" id="previewCover">封面預覽</div>
            <div class="preview-body">
                <div class="meta-row">
                    <span class="meta-chip" id="previewCategory">分類</span>
                    <span class="meta-chip" id="previewReading">約 1 分鐘讀完</span>
                </div>
                <h3 class="post-title" id="previewTitle">尚未輸入標題</h3>
                <p class="post-excerpt" id="previewExcerpt">開始輸入內容，預覽會同步更新。</p>
            </div>
        </div>
    </section>

</div>

<!-- ===============================
     Quill.js CDN
================================= -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<!-- ===============================
     初始化 Quill（含預載 HTML）
================================= -->
<script>
document.addEventListener("DOMContentLoaded", function () {

    // 1️⃣ 建立 Quill 編輯器（完整工具列）
    var quill = new Quill("#quillEditor-edit", {
        theme: "snow",
        placeholder: "請輸入文章內容…",
        modules: {
            toolbar: "#toolbar-edit"
        }
    });

    // 2️⃣ 自訂 HR 分隔線
    var Block = Quill.import("blots/block");
    class Divider extends Block {}
    Divider.blotName = "divider";
    Divider.tagName = "hr";
    Quill.register(Divider);

    document.getElementById("insert-hr-edit").addEventListener("click", function () {
        let range = quill.getSelection();
        if (range) {
            quill.insertEmbed(range.index, "divider", true);
            quill.insertText(range.index + 1, "\n");
        }
    });

    // 3️⃣ 預載文章內容
    var rawHTML = document.getElementById("rawContent").innerHTML;
    quill.root.innerHTML = rawHTML;

    // 4️⃣ 表單送出 → 塞 HTML
    document.getElementById("editPostForm").onsubmit = function () {
        var html = quill.root.innerHTML.trim();
        if (html === "<p><br></p>" || html.length < 5) {
            alert("文章內容不得為空");
            return false;
        }
        document.getElementById("contentInput-edit").value = html;
    };

    // 即時預覽
    const titleInput = document.querySelector("input[name='title']");
    const categorySelect = document.querySelector("select[name='category_id']");
    const coverInput = document.querySelector("input[name='cover_image']");
    const previewTitle = document.getElementById("previewTitle");
    const previewExcerpt = document.getElementById("previewExcerpt");
    const previewCategory = document.getElementById("previewCategory");
    const previewReading = document.getElementById("previewReading");
    const previewCover = document.getElementById("previewCover");

    function updatePreview() {
        previewTitle.textContent = titleInput.value.trim() || "尚未輸入標題";

        const plain = quill.getText().trim();
        const words = plain ? plain.split(/\s+/).length : 0;
        const minutes = Math.max(1, Math.round(words / 220));
        previewReading.textContent = `約 ${minutes} 分鐘讀完`;
        previewExcerpt.textContent = plain ? (plain.slice(0, 120) + (plain.length > 120 ? "…" : "")) : "開始輸入內容，預覽會同步更新。";

        const categoryText = categorySelect.options[categorySelect.selectedIndex]?.text || "分類";
        previewCategory.textContent = categoryText;

        const coverUrl = coverInput.value.trim();
        if (coverUrl) {
            previewCover.innerHTML = `<img src=\"${coverUrl}\" alt=\"cover preview\">`;
        } else {
            previewCover.textContent = "封面預覽";
            previewCover.innerHTML = "";
            previewCover.textContent = "封面預覽";
        }
    }

    titleInput.addEventListener("input", updatePreview);
    categorySelect.addEventListener("change", updatePreview);
    coverInput.addEventListener("input", updatePreview);
    quill.on("text-change", updatePreview);
    updatePreview();

});
</script>

<!-- 安全載入 HTML → 給 JS 預填 Quill -->
<div id="rawContent" style="display:none;">
    {{ post.content | safe }}
</div>

{% endblock %}
