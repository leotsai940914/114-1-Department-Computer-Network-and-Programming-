{% extends "base.html" %}
{% block content %}

<div class="container">

    <h2 class="section-title">新增文章</h2>

    <form id="postForm"
          class="newpost-form"
          method="POST"
          action="{{ url_for('post_routes.new_post') }}">

        {% if error %}
        <p style="color:#b00020; margin-bottom:1rem;">{{ error }}</p>
        {% endif %}

        <!-- 標題 -->
        <label class="form-label">文章標題</label>
        <input type="text" class="form-input" name="title"
               placeholder="請輸入文章標題" required>

        <!-- 工具列 -->
        <div id="toolbar-new">
            <span class="ql-formats">
                <select class="ql-header">
                    <option selected></option>
                    <option value="1">H1</option>
                    <option value="2">H2</option>
                    <option value="3">H3</option>
                    <option value="4">H4</option>
                </select>
            </span>

            <span class="ql-formats">
                <button class="ql-bold"></button>
                <button class="ql-italic"></button>
                <button class="ql-underline"></button>
            </span>

            <span class="ql-formats">
                <button class="ql-align" value=""></button>
                <button class="ql-align" value="center"></button>
                <button class="ql-align" value="right"></button>
                <button class="ql-align" value="justify"></button>
            </span>

            <span class="ql-formats">
                <button class="ql-indent" value="-1"></button>
                <button class="ql-indent" value="+1"></button>
            </span>

            <span class="ql-formats">
                <button class="ql-list" value="ordered"></button>
                <button class="ql-list" value="bullet"></button>
            </span>

            <span class="ql-formats">
                <button class="ql-blockquote"></button>
                <button class="ql-code-block"></button>
            </span>

            <span class="ql-formats">
                <button class="ql-link"></button>
                <button class="ql-image"></button>
            </span>

            <span class="ql-formats">
                <button id="insert-hr-new">HR</button>
            </span>

            <span class="ql-formats">
                <button class="ql-clean"></button>
            </span>
        </div>

        <!-- Quill 編輯器 -->
        <div id="quillEditor-new" style="height:350px;background:#fff;"></div>

        <input type="hidden" name="content" id="contentInput-new">

        <!-- 分類 -->
        <label class="form-label">文章分類</label>
        <select class="form-input" name="category_id" required>
            {% for c in categories %}
            <option value="{{ c.id }}">{{ c.name }}</option>
            {% endfor %}
        </select>

        <!-- 封面 -->
        <label class="form-label">封面圖片 URL（選填）</label>
        <input type="text" class="form-input" name="cover_image"
               placeholder="https://example.com/poster.jpg">

        <button class="submit-btn" type="submit">發布文章</button>

    </form>

</div>

<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

    var quill = new Quill("#quillEditor-new", {
        theme: "snow",
        placeholder: "請輸入文章內容…",
        modules: { toolbar: "#toolbar-new" }
    });

    // HR 插入
    var Block = Quill.import("blots/block");
    class Divider extends Block {}
    Divider.blotName = "divider";
    Divider.tagName = "hr";
    Quill.register(Divider);

    document.getElementById("insert-hr-new").addEventListener("click", function () {
        let range = quill.getSelection();
        if (range) {
            quill.insertEmbed(range.index, "divider");
            quill.insertText(range.index + 1, "\n");
        }
    });

    // Submit
    document.getElementById("postForm").onsubmit = function () {
        let html = quill.root.innerHTML.trim();
        if (html === "<p><br></p>") {
            alert("文章內容不得為空");
            return false;
        }
        document.getElementById("contentInput-new").value = html;
    };

});
</script>

{% endblock %}