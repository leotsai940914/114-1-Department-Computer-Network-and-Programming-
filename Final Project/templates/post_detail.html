{% extends "base.html" %}
{% block content %}

<div class="container">

    <!-- ====== 文章標題 ====== -->
    <h1 class="post-detail-title">{{ post.title }}</h1>

    <!-- ====== 分類 & 日期 ====== -->
    <div class="post-detail-meta">
        <span class="meta-chip">{{ post.category_name }}</span>
        <span class="meta-chip">{{ post.created_at }}</span>
        <span class="meta-chip reading-time">約 {{ reading_time }} 分鐘讀完</span>
    </div>

    <!-- ====== 封面圖片（若有） ====== -->
    {% if post.cover_image_url %}
    <img src="{{ post.cover_image_url }}" 
         alt="Cover Image"
         style="width:100%; border-radius:6px; margin-bottom:1.5rem;"
         class="cover-image">
    {% endif %}

    <!-- ====== 文章內容（圖片將由 JS 自動加 lazy load + lightbox） ====== -->
    <div class="toc-container" id="tocContainer">
        <div class="toc-header">
            <span>目錄</span>
            <button type="button" class="toc-toggle" aria-label="toggle toc">展開</button>
        </div>
        <nav id="toc"></nav>
    </div>

    <article class="post-detail-content" id="postContent">
        {{ post.content | safe }}
    </article>

    <hr class="divider">

    <!-- ====== 續讀推薦 ====== -->
    <section class="related-section">
        <h3 class="section-title">延伸閱讀</h3>
        <div class="related-grid">
            {% if prev_post %}
            <a class="related-card" href="{{ url_for('post_routes.post_detail', post_id=prev_post['id']) }}">
                <p class="eyebrow">上一篇</p>
                <p class="related-title">{{ prev_post['title'] }}</p>
            </a>
            {% endif %}
            {% if next_post %}
            <a class="related-card" href="{{ url_for('post_routes.post_detail', post_id=next_post['id']) }}">
                <p class="eyebrow">下一篇</p>
                <p class="related-title">{{ next_post['title'] }}</p>
            </a>
            {% endif %}
            {% for rp in related_posts %}
            <a class="related-card" href="{{ url_for('post_routes.post_detail', post_id=rp['id']) }}">
                <p class="eyebrow">同分類</p>
                <p class="related-title">{{ rp['title'] }}</p>
            </a>
            {% endfor %}
        </div>
    </section>

    <!-- ====== 留言區 ====== -->
    <section class="comment-section">
        <h2 class="comment-title">留言區 Comments</h2>

        {% if request.args.get('error') %}
        <p style="color:#b00020; margin-bottom:1rem;">
            {{ request.args.get('error') }}
        </p>
        {% endif %}

        <!-- 留言表單 -->
        <form class="comment-form" 
              method="POST"
              action="{{ url_for('comment_routes.add_comment', post_id=post.id) }}">
            <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">

            <label>
                暱稱
                <input type="text" name="nickname" placeholder="輸入暱稱">
            </label>

            <label>
                留言內容
                <textarea name="content" placeholder="輸入留言內容（不需登入）"></textarea>
            </label>

            <button class="comment-btn" type="submit">提交留言</button>
        </form>

        <!-- ====== 留言列表 ====== -->
        <div class="comment-list">
            {% if comments %}
                {% for c in comments %}
                <div class="comment-item">
                    <p class="comment-author">{{ c.nickname }}：</p>
                    <p class="comment-text">{{ c.content }}</p>
                    <p style="font-size:0.8rem; color:#999;">{{ c.created_at }}</p>
                </div>
                {% endfor %}
            {% else %}
                <p style="color:#666;">還沒有留言，成為第一位留言的人吧！</p>
            {% endif %}
        </div>

    </section>

</div>


<!-- ====== Admin 控制按鈕（編輯 / 刪除） ====== -->
{% if session.get("role") == "admin" %}
<div style="margin-top: 2rem;" class="container">
    <div style="display:flex; gap:1rem;">

        <!-- 編輯文章 -->
        <a href="{{ url_for('post_routes.edit_post', post_id=post.id) }}"
           style="
               background:#222;
               color:#fff;
               padding:0.5rem 1rem;
               border-radius:6px;
               text-decoration:none;
               transition:0.25s ease;
           ">
            編輯文章
        </a>

        <!-- 刪除文章 -->
        <form method="POST"
              action="{{ url_for('post_routes.delete_post', post_id=post.id) }}"
              onsubmit="return confirm('確定要刪除這篇文章嗎？此動作無法復原。');">
            <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">

            <button type="submit" style="
                background:#b00020;
                color:#fff;
                padding:0.5rem 1rem;
                border:none;
                border-radius:6px;
                cursor:pointer;
                transition:0.25s ease;
            ">
                刪除文章
            </button>
        </form>

    </div>
</div>
{% endif %}

<!-- ===========================================
     Lightbox Overlay（必要 DOM）
=========================================== -->
<div id="lightboxOverlay" style="display:none;">
    <img id="lightboxImage" src="">
</div>

{% endblock %}
